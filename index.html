<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Special Message</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
      #audio-controls {
        position: fixed;
        bottom: 24px;
        right: 24px;
        background: rgba(255,255,255,0.85);
        border-radius: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        padding: 10px 18px;
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 2000;
      }
      #mute-btn {
        background: #ffb3d9;
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        outline: none;
        transition: background 0.2s;
        padding: 0;
      }
      #mute-btn i {
        font-size: 22px;
        color: #ff69b4;
        display: block;
      }
      #mute-btn:hover {
        background: #ff69b4;
      }
      #mute-btn:hover i {
        color: #fff;
      }
      #volume-slider {
        accent-color: #ff69b4;
        width: 80px;
      }
      .final-quiz-getready, .final-quiz-loading, .final-quiz-question, #finalQuizFeedback {
          text-align: center;
          font-size: 1.2em;
          margin-bottom: 15px;
          color: #ff69b4 !important;
          font-family: 'Klop', 'Fredoka', 'Comic Sans MS', cursive, sans-serif;
          max-width: 420px;
          margin-left: auto;
          margin-right: auto;
      }
      .final-quiz-loading {
          display: flex;
          justify-content: center;
          align-items: center;
          height: 40px;
      }
      .loading-dots {
          display: flex;
          justify-content: center;
          align-items: center;
          gap: 10px;
          font-size: 2.5em;
          color: #ffb3d9;
          width: 100px;
      }
      .loading-dot {
          animation: loadingDotFade 1.2s infinite;
          color: #ff69b4;
          font-weight: bold;
      }
      .loading-dot:nth-child(1) { animation-delay: 0s; }
      .loading-dot:nth-child(2) { animation-delay: 0.2s; }
      .loading-dot:nth-child(3) { animation-delay: 0.4s; }
      @keyframes loadingDotFade {
          0%, 80%, 100% { opacity: 0.3; }
          40% { opacity: 1; }
      }
      #finalQuizFeedback {
          margin-top: 32px;
          color: #ff69b4 !important;
          text-align: center;
          font-size: 1.2em;
          font-family: 'Klop', 'Fredoka', 'Comic Sans MS', cursive, sans-serif;
      }
      .pattern-cell.selected {
        box-shadow: 0 0 0 4px #ffb3d9, 0 8px 20px rgba(255, 105, 180, 0.4);
        border-color: #ff69b4;
        background: linear-gradient(45deg, #fffbe6, #ffe6f2);
        filter: brightness(1.15);
      }
    </style>
</head>
<body>
    <div class="container">
      <button id="cat-purr-btn" aria-label="Pet the cat!" style="position: absolute; top: -20px; right: -10px; width: 100px; height: 100px; background: transparent; border: none; cursor: pointer; z-index: 30; outline: none;"></button>
        <!-- Welcome Screen -->
        <div id="welcome" class="welcome-screen">
            <h1>welcome nini! :D</h1>
            <div class="message">
                <p>hi pretty girl &lt;3</p>
                <p>I've created some cute little games and puzzles just for you!</p>
                <p>Complete them all to discover a special message...</p>
            </div>
            <button class="btn" onclick="startAdventure()">Start!</button>
        </div>

        <!-- Game 1: Memory Game -->
        <div id="game1" class="game-screen">
            <h2>Memory Game with Cats!</h2>
            <div class="message">Find all the matching cat pairs! They're so cute and chubby!</div>
            <div class="score">Pairs Found: <span id="memoryScore">0</span>/8</div>
            <div class="game-area">
                <div class="memory-grid" id="memoryGrid"></div>
            </div>
            <button class="btn" onclick="showHint('memory')">Need a Hint? üí°</button>
        </div>

        <!-- Game 2: Cat Catching -->
        <div id="game2" class="game-screen">
            <h2>Catch the Chubby Cats!</h2>
            <div class="message">Click on the cats as they appear! Catch 20 to continue!</div>
            <div class="score">Cats Caught: <span id="catScore">0</span>/20</div>
            <div class="timer">Time: <span id="catTimer">30</span>s</div>
            <div class="game-area">
                <div class="cat-game" id="catGame">
                    <div class="cat-start" id="catStart">
                        <h3>Ready to catch some cats?</h3>
                        <p>Click the button below when you're ready to begin!</p>
                        <button class="btn" onclick="startCatGame()">Start Game</button>
                    </div>
                    <div class="cat-countdown" id="catCountdown" style="display: none;">
                        <h3>Get Ready!</h3>
                        <div class="countdown-number" id="catCountdownNumber">3</div>
                    </div>
                    <div class="cat-game-area" id="catGameArea"></div>
                </div>
            </div>
        </div>

        <!-- Game 3: Quiz About You -->
        <div id="game3" class="game-screen">
            <h2>Quiz About Me!</h2>
            <div class="message">Let's see how well you know me! Answer these 3 questions correctly to continue!</div>
            <div class="score">Questions Correct: <span id="quizScore">0</span>/3</div>
            <div class="game-area">
                <div class="quiz-container" id="quizContainer">
                    <div class="question" id="question1">
                        <h3>Question 1:</h3>
                        <p>What's my favorite color?</p>
                        <div class="quiz-options">
                            <button class="quiz-btn" onclick="checkAnswer(1, 'black')">Black</button>
                            <button class="quiz-btn" onclick="checkAnswer(1, 'pink')">Pink</button>
                            <button class="quiz-btn" onclick="checkAnswer(1, 'blue')">Blue</button>
                            <button class="quiz-btn" onclick="checkAnswer(1, 'purple')">Purple</button>
                        </div>
                    </div>
                    <div class="question" id="question2" style="display: none;">
                        <h3>Question 2:</h3>
                        <p>When is my birthday?</p>
                        <div class="quiz-options">
                            <button class="quiz-btn" onclick="checkAnswer(2, '11th october 2006')">11th October 2006</button>
                            <button class="quiz-btn" onclick="checkAnswer(2, '23rd march 2007')">23rd March 2007</button>
                            <button class="quiz-btn" onclick="checkAnswer(2, '5th may 2006')">5th May 2006</button>
                            <button class="quiz-btn" onclick="checkAnswer(2, '1st january 2005')">1st January 2005</button>
                        </div>
                    </div>
                    <div class="question" id="question3" style="display: none;">
                        <div id="finalQuizStage">
                            <!-- This will be filled by JS: get ready, drumroll, loading, then final question -->
                        </div>
                    </div>
                </div>
            </div>
            <button class="btn" onclick="showHint('quiz')">Need a Hint? üí°</button>
        </div>

        <!-- Difficulty Prompt -->
        <div id="difficulty-prompt" class="game-screen">
            <h2>Ready for a Challenge?</h2>
            <div class="message">
                <p>Great job on the quiz! You know me so well!</p>
                <p>Now it's time to step it up a notch...</p>
                <p>Are you ready for something a bit more challenging?</p>
            </div>
            <div class="game-area">
                <div class="difficulty-container">
                    <button class="quiz-btn" onclick="startChallenge()">Okay</button>
                </div>
            </div>
        </div>

        <!-- Game 4: Pattern Memory (Placeholder) -->
        <div id="game4" class="game-screen">
            <h2>Pattern Memory Challenge!</h2>
            <div class="message">Watch carefully and repeat the pattern! It gets harder each round!</div>
            <div class="score">Level: <span id="patternLevel">1</span> | Score: <span id="patternScore">0</span></div>
            <div class="game-area">
                <div class="pattern-game" id="patternGame">
                    <div class="pattern-start" id="patternStart">
                        <h3>Ready to start?</h3>
                        <p>Click the button below when you're ready to begin!</p>
                        <button class="btn" onclick="startPatternGame()">Start Game</button>
                    </div>
                    <div class="pattern-countdown" id="patternCountdown" style="display: none;">
                        <h3>Get Ready!</h3>
                        <div class="countdown-number" id="countdownNumber">3</div>
                    </div>
                    <div class="pattern-grid" id="patternGrid" style="display: none;">
                        <div class="pattern-cell" data-index="0">üíï</div>
                        <div class="pattern-cell" data-index="1">üê±</div>
                        <div class="pattern-cell" data-index="2">üê∞</div>
                        <div class="pattern-cell" data-index="3">üå∏</div>
                    </div>
                </div>
            </div>
            <button class="btn" onclick="showHint('pattern')">Need a Hint? üí°</button>
        </div>

        <!-- Final Message Book -->
        <div id="final" class="final-message book-message" style="display:none;">
            <div class="book-nav book-nav-left" id="bookPrev" style="display:none;" onclick="bookPrevPage()">
                <i class='bx bx-chevron-left'></i>
            </div>
            <div class="book-pages">
                <!-- Page 1: Main message -->
                <div class="book-page" id="bookPage0">
                    <h2>You Did It!</h2>
                    <p>hi, congrats ‚Äî you made it! üéâ</p>
                    <p>i just wanted to say‚Ä¶ thank you.</p>
                    <p>for everything. for being here, for putting up with me, for always loving me even when i make things difficult.</p>
                    <p>i know i‚Äôve caused some trouble along the way, and i‚Äôm really sorry for that. you never deserved the stress,</p>
                    <p>but you still stayed ‚Äî and that means the world to me.</p>
                    <p>and as a tiny thank-you, there‚Äôs a $50 steam card waiting for you on wednesday when i get paid üíñ</p>
                    <p>you‚Äôre amazing, and you deserve so much more than this.</p>
                    <p>i love you always,</p>
                    <p>‚Äì noah</p>
                    <div style="font-size: 2em; margin: 20px 0;">
                        üê∞üíïüê±üíïüê∞üíïüê±üíïüê∞
                    </div>
                </div>
                <!-- Page 2: Voice message -->
                <div class="book-page" id="bookPage1" style="display:none;">
                    <h2>Voice Message</h2>
                    <div class="voice-player">
                        <audio id="voiceAudio" src="audio/voice-message.mp3"></audio>
                        <button id="voicePlayBtn" class="voice-play-btn" onclick="toggleVoicePlayback()">
                            <i id="voicePlayIcon" class='bx bx-play'></i>
                        </button>
                        <div class="voice-progress-bar">
                            <input id="voiceProgress" type="range" min="0" max="100" value="0" step="0.1">
                        </div>
                        <div class="voice-time">
                            <span id="voiceCurrent">0:00</span> / <span id="voiceDuration">0:00</span>
                        </div>
                    </div>
                    <div style="margin-top: 18px; color: #ff69b4; font-family: 'Klop', 'Fredoka', 'Comic Sans MS', cursive, sans-serif; font-size: 1.1em;">(turn up your volume!)</div>
                </div>
            </div>
            <div id="bookPageIndicator" style="margin: 18px auto 0 auto; text-align: center; color: #ff69b4; font-family: 'Klop', 'Fredoka', 'Comic Sans MS', cursive, sans-serif; font-size: 1.1em;">Page 1/2</div>
            <div class="book-nav book-nav-right" id="bookNext" onclick="bookNextPage()">
                <i class='bx bx-chevron-right'></i>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="progress">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div style="text-align: center; margin-top: 5px; color: #ff69b4;">
                Progress: <span id="progressText">0</span>/4
            </div>
        </div>

        <!-- Dev Mode Panel (Hidden by default) -->
        <div id="devPanel" class="dev-panel" style="display: none;">
            <h3>Dev Mode - Skip to Section</h3>
            <div class="dev-buttons">
                <button class="dev-btn" onclick="devSkipTo('welcome')">Welcome Screen</button>
                <button class="dev-btn" onclick="devSkipTo('game1')">Memory Game</button>
                <button class="dev-btn" onclick="devSkipTo('game2')">Cat Catching</button>
                <button class="dev-btn" onclick="devSkipTo('game3')">Quiz</button>
                <button class="dev-btn" onclick="devSkipTo('difficulty-prompt')">Difficulty Prompt</button>
                <button class="dev-btn" onclick="devSkipTo('game4')">Pattern Memory</button>
                <button class="dev-btn" onclick="devSkipTo('final')">Final Message</button>
            </div>
            <button class="dev-btn" onclick="toggleDevMode()">Close Dev Panel</button>
        </div>
    </div>

    <!-- Background Music Player -->
    <audio id="bg-music" src="audio/background2.mp3" autoplay loop></audio>
    <audio id="pop-sound" src="audio/pop.mp3" preload="auto"></audio>
    <audio id="drumroll-sound" src="audio/drumroll.mp3" preload="auto"></audio>
    <audio id="purr-sound" src="audio/purr.mp3" preload="auto"></audio>
    <div id="audio-controls">
      <button id="mute-btn" aria-label="Mute/Unmute">
        <i id="icon-sound" class='bx bx-volume-full'></i>
      </button>
      <input id="volume-slider" type="range" min="0" max="1" step="0.01" value="0.15">
      <button id="shuffle-btn" aria-label="Shuffle" style="background: #ffe6f2; border: 2px solid #ffb3d9; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; margin-left: 8px; cursor: pointer;"><i id="icon-shuffle" class='bx bx-shuffle'></i></button>
      <button id="loop-btn" aria-label="Loop" style="background: #ffe6f2; border: 2px solid #ffb3d9; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; margin-left: 6px; cursor: pointer; position: relative;">
        <i id="icon-loop" class='bx bx-repeat'></i>
        <span id="loop-badge" style="display:none; position:absolute; top:2px; right:2px; background:#fff; color:#ff69b4; font-size:0.7em; border-radius:50%; width:13px; height:13px; display:block; align-items:center; justify-content:center; font-family:'Klop','Fredoka',sans-serif; font-weight:bold; box-shadow:0 1px 4px rgba(255,105,180,0.10); pointer-events:none; text-align:center; line-height:13px;">1</span>
      </button>
      <select id="music-select" aria-label="Choose background music" style="border-radius: 12px; border: 2px solid #ffb3d9; background: #ffe6f2; color: #ff69b4; font-family: 'Klop', 'Fredoka', 'Comic Sans MS', cursive, sans-serif; font-size: 1em; margin-left: 10px; padding: 0 12px; line-height: 32px; height: 32px; display: inline-block; vertical-align: middle;">
        <option value="off">Off</option>
        <option value="background.mp3">Cute Vibes</option>
        <option value="background2.mp3">Soft & Sad</option>
        <option value="background3.mp3">Barista Lofi</option>
      </select>
    </div>
    <script>
      window.addEventListener('DOMContentLoaded', function() {
        var audio = document.getElementById('bg-music');
        var muteBtn = document.getElementById('mute-btn');
        var slider = document.getElementById('volume-slider');
        var iconSound = document.getElementById('icon-sound');
        var musicSelect = document.getElementById('music-select');
        var shuffleBtn = document.getElementById('shuffle-btn');
        var loopBtn = document.getElementById('loop-btn');
        var iconShuffle = document.getElementById('icon-shuffle');
        var iconLoop = document.getElementById('icon-loop');
        var loopBadge = document.getElementById('loop-badge');
        // Track list (update if you add more tracks)
        var tracks = [
          'background.mp3',
          'background2.mp3',
          'background3.mp3'
        ];
        // State
        var shuffleOn = false;
        var loopMode = 0; // 0 = off, 1 = loop all, 2 = loop one
        // Set default UI states
        function updateShuffleUI() {
          if (shuffleOn) {
            shuffleBtn.style.background = '#ffb3d9';
            iconShuffle.style.color = '#fff';
          } else {
            shuffleBtn.style.background = '#ffe6f2';
            iconShuffle.style.color = '#ff69b4';
          }
        }
        function updateLoopUI() {
          if (loopMode === 1) {
            loopBtn.style.background = '#ffb3d9';
            iconLoop.className = 'bx bx-repeat';
            iconLoop.style.color = '#fff';
            loopBadge.style.display = 'none';
          } else if (loopMode === 2) {
            loopBtn.style.background = '#ff69b4';
            iconLoop.className = 'bx bx-repeat-one';
            iconLoop.style.color = '#fff';
            loopBadge.style.display = 'flex';
          } else {
            loopBtn.style.background = '#ffe6f2';
            iconLoop.className = 'bx bx-repeat';
            iconLoop.style.color = '#ff69b4';
            loopBadge.style.display = 'none';
          }
        }
        updateShuffleUI();
        updateLoopUI();
        // Shuffle button
        shuffleBtn.addEventListener('click', function() {
          shuffleOn = !shuffleOn;
          updateShuffleUI();
        });
        // Loop button
        loopBtn.addEventListener('click', function() {
          loopMode = (loopMode + 1) % 3;
          updateLoopUI();
        });
        // Music selector
        musicSelect.value = 'background2.mp3'; // Always default to Soft & Sad
        musicSelect.addEventListener('change', function() {
          var wasPlaying = !audio.paused;
          var prevVolume = audio.volume;
          var prevMuted = audio.muted;
          if (musicSelect.value === 'off') {
            audio.pause();
            audio.muted = true;
          } else {
            audio.src = 'audio/' + musicSelect.value;
            audio.load();
            audio.volume = prevVolume;
            audio.muted = prevMuted;
            if (wasPlaying && !audio.muted) {
              audio.play().catch(()=>{});
            }
          }
        });
        // Track end logic
        audio.addEventListener('ended', function() {
          if (musicSelect.value === 'off') return;
          if (loopMode === 2) {
            // Loop one
            audio.currentTime = 0;
            audio.play();
          } else if (shuffleOn) {
            // Shuffle (pick a random track, not the current one)
            var current = musicSelect.value;
            var available = tracks.filter(function(t) { return t !== current; });
            var next = available[Math.floor(Math.random() * available.length)];
            musicSelect.value = next;
            audio.src = 'audio/' + next;
            audio.load();
            audio.play();
          } else if (loopMode === 1) {
            // Loop all
            var idx = tracks.indexOf(musicSelect.value);
            var nextIdx = (idx + 1) % tracks.length;
            var next = tracks[nextIdx];
            musicSelect.value = next;
            audio.src = 'audio/' + next;
            audio.load();
            audio.play();
          } else {
            // No loop, no shuffle: stop
            // Do nothing
          }
        });
        // Mute/unmute
        muteBtn.addEventListener('click', function() {
          audio.muted = !audio.muted;
          if (audio.muted) {
            iconSound.className = 'bx bx-volume-mute';
          } else {
            iconSound.className = 'bx bx-volume-full';
          }
        });
        // Volume slider
        slider.addEventListener('input', function() {
          audio.volume = slider.value;
          if (audio.volume == 0) {
            audio.muted = true;
            iconSound.className = 'bx bx-volume-mute';
          } else {
            audio.muted = false;
            iconSound.className = 'bx bx-volume-full';
          }
        });
        // Set initial icon
        if (audio.muted || audio.volume == 0) {
          iconSound.className = 'bx bx-volume-mute';
        } else {
          iconSound.className = 'bx bx-volume-full';
        }
        // --- Combined unlock for both music and beep audio context ---
        function unlockAllAudio() {
          // Resume beep audio context if needed
          if (window.audioCtx && window.audioCtx.state === 'suspended') {
            window.audioCtx.resume();
          }
          // Play and resume background music if needed
          var audio = document.getElementById('bg-music');
          var slider = document.getElementById('volume-slider');
          if (audio) {
            audio.muted = false;
            audio.volume = slider.value;
            audio.play().catch(()=>{});
          }
          window.removeEventListener('click', unlockAllAudio);
          window.removeEventListener('keydown', unlockAllAudio);
          window._audioUnlocked = true;
        }
        window._audioUnlocked = false;
        window.addEventListener('click', unlockAllAudio);
        window.addEventListener('keydown', unlockAllAudio);

        var catPurrBtn = document.getElementById('cat-purr-btn');
        var purrSound = document.getElementById('purr-sound');
        if (catPurrBtn && purrSound) {
          catPurrBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            purrSound.currentTime = 0;
            purrSound.volume = 0.5;
            purrSound.play();
          });
        }
      });
    </script>
    <script>
        let currentGame = 0;
        let progress = 0;
        let memoryCards = [];
        let flippedCards = [];
        let catScore = 0;
        let bunnyScore = 0;
        let catTimer = 30;
        let catInterval;
        let bunnyPositions = [];
        let devMode = false;
        // Track which cat images are currently on screen
        let catsOnScreen = new Set();
        // Maximum number of cats allowed on screen at once
        const MAX_CATS_ON_SCREEN = 4;

        const games = ['welcome', 'game1', 'game2', 'game3', 'game4', 'final'];

        // Memory game cards
        const catImages = [
          'images/grey white pattern cat.png',
          'images/pattern orange cat.png',
          'images/dark orange white cat.png',
          'images/light orange white cat.png',
          'images/black white cat.png',
          'images/light orange cat.png',
          'images/white grey cat.png',
          'images/orange white cat.png',
          'images/white cat.png'
        ];

        // Quiz game
        let quizScore = 0;
        let currentQuestion = 1;
        const correctAnswers = {
            1: 'black',
            2: '11th october 2006',
            3: 'yes' // for the final question, yes is the correct answer
        };

        // Pattern memory game
        let patternSequence = [];
        let playerSequence = [];
        let patternLevel = 1;
        let patternScore = 0;
        let isShowingPattern = false;
        let isPlayerTurn = false;
        // Frequencies for each pattern cell (üíï, üê±, üê∞, üå∏)
        const patternFrequencies = [440, 554, 659, 784]; // A4, C#5, E5, G5

        // Play a beep at a given frequency (Hz)
        function playBeep(frequency, duration = 180, volume = 0.18) {
            try {
                const ctx = window.audioCtx || (window.audioCtx = new (window.AudioContext || window.webkitAudioContext)());
                const oscillator = ctx.createOscillator();
                const gain = ctx.createGain();
                oscillator.type = 'sine';
                oscillator.frequency.value = frequency;
                gain.gain.value = volume;
                oscillator.connect(gain);
                gain.connect(ctx.destination);
                oscillator.start();
                oscillator.stop(ctx.currentTime + duration / 1000);
                oscillator.onended = () => {
                    gain.disconnect();
                    oscillator.disconnect();
                };
            } catch (e) {
                // Fail silently if audio context fails
            }
        }

        function startAdventure() {
            currentGame = 1;
            showGame('game1');
            initMemoryGame();
        }

        function showGame(gameId) {
            document.querySelectorAll('.game-screen, .welcome-screen, .final-message').forEach(el => {
                el.style.display = 'none';
            });
            document.getElementById(gameId).style.display = 'block';
            updateProgress();
        }

        function updateProgress() {
            // Map game states to progress values
            let progressValue;
            switch(currentGame) {
                case 0: // Welcome
                    progressValue = 0;
                    break;
                case 1: // Memory Game
                    progressValue = 1;
                    break;
                case 2: // Cat Catching
                    progressValue = 2;
                    break;
                case 3: // Quiz
                    progressValue = 3;
                    break;
                case 3.5: // Difficulty Prompt
                    progressValue = 3;
                    break;
                case 4: // Pattern Memory
                    progressValue = 4;
                    break;
                case 5: // Final Message
                    progressValue = 4;
                    break;
                default:
                    progressValue = 0;
            }
            
            progress = progressValue;
            const percentage = (progress / 4) * 100;
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = progress;
        }

        function initMemoryGame() {
            const grid = document.getElementById('memoryGrid');
            grid.innerHTML = '';
            // Select 8 random cat images from the 9 available
            let shuffledCats = [...catImages].sort(() => Math.random() - 0.5);
            let selectedCats = shuffledCats.slice(0, 8);
            // Create pairs (16 cards)
            let pairs = [...selectedCats, ...selectedCats];
            // Shuffle the 16 cards
            memoryCards = pairs.sort(() => Math.random() - 0.5);
            memoryCards.forEach((imgSrc, index) => {
                const card = document.createElement('div');
                card.className = 'memory-card';
                card.dataset.index = index;
                card.dataset.img = imgSrc;
                card.addEventListener('click', flipCard);
                grid.appendChild(card);
            });
            // Reset score display
            document.getElementById('memoryScore').textContent = '0';
        }

        function flipCard() {
            if (flippedCards.length === 2) return;
            if (this.classList.contains('flipped')) return;

            this.classList.add('flipped');
            const img = document.createElement('img');
            img.src = this.dataset.img;
            img.alt = 'Cat';
            img.style.width = '80%';
            img.style.height = '80%';
            img.style.objectFit = 'contain';
            this.appendChild(img);
            flippedCards.push(this);

            if (flippedCards.length === 2) {
                setTimeout(checkMatch, 1000);
            }
        }

        function checkMatch() {
            const [card1, card2] = flippedCards;
            if (card1.dataset.img === card2.dataset.img) {
                document.getElementById('memoryScore').textContent = 
                    parseInt(document.getElementById('memoryScore').textContent) + 1;
                
                if (parseInt(document.getElementById('memoryScore').textContent) === 8) {
                    setTimeout(() => {
                        alert('Fantastic memory! You found all the pairs perfectly! You\'re so smart!');
                        currentGame = 2;
                        showGame('game2');
                        initCatGame();
                    }, 1000);
                }
            } else {
                card1.classList.remove('flipped');
                card2.classList.remove('flipped');
                card1.innerHTML = '';
                card2.innerHTML = '';
            }
            flippedCards = [];
        }

        // Replace initCatGame and related logic with new start/coundown logic
        function initCatGame() {
            catScore = 0;
            catTimer = 15;
            document.getElementById('catScore').textContent = '0';
            document.getElementById('catTimer').textContent = '15';
            // Show start screen
            document.getElementById('catStart').style.display = 'block';
            document.getElementById('catCountdown').style.display = 'none';
            document.getElementById('catGameArea').style.display = 'block';
            // Remove any cats
            document.getElementById('catGameArea').innerHTML = '';
            // Reset catsOnScreen
            catsOnScreen = new Set();
        }

        function startCatGame() {
            // Hide start screen, show countdown
            document.getElementById('catStart').style.display = 'none';
            document.getElementById('catCountdown').style.display = 'flex';
            document.getElementById('catGameArea').style.display = 'block';
            let countdown = 3;
            const countdownElement = document.getElementById('catCountdownNumber');
            countdownElement.textContent = countdown;
            const countdownInterval = setInterval(() => {
                countdown--;
                countdownElement.textContent = countdown > 0 ? countdown : 'Go!';
                countdownElement.style.animation = 'none';
                setTimeout(() => {
                    countdownElement.style.animation = 'pulse 1s ease-in-out';
                }, 10);
                if (countdown < 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('catCountdown').style.display = 'none';
                    document.getElementById('catGameArea').style.display = 'block';
                    runCatGame();
                }
            }, 1000);
        }

        function runCatGame() {
            catScore = 0;
            catTimer = 15;
            document.getElementById('catScore').textContent = '0';
            document.getElementById('catTimer').textContent = '15';
            document.getElementById('catGameArea').innerHTML = '';
            // Start timer countdown (real seconds)
            catTimerInterval = setInterval(() => {
                catTimer--;
                document.getElementById('catTimer').textContent = catTimer;
                if (catTimer <= 0) {
                    clearInterval(catTimerInterval);
                    clearInterval(catInterval);
                    alert('Time\'s up! Try again!');
                    initCatGame();
                }
            }, 1000);
            // Start cat spawning (faster interval)
            catInterval = setInterval(() => {
                // Only spawn if we can add more unique cats
                if (catsOnScreen.size < MAX_CATS_ON_SCREEN) {
                    spawnCat();
                }
            }, 250); // Faster spawn interval
        }

        function spawnCat() {
            const gameArea = document.getElementById('catGameArea');
            // Find available cat numbers not currently on screen
            let availableCats = [];
            for (let i = 1; i <= 7; i++) {
                if (!catsOnScreen.has(i)) availableCats.push(i);
            }
            if (availableCats.length === 0) return; // No available cats to spawn
            const catNum = availableCats[Math.floor(Math.random() * availableCats.length)];
            catsOnScreen.add(catNum);
            const cat = document.createElement('div');
            cat.className = 'cat';
            cat.dataset.catNum = catNum;
            const img = document.createElement('img');
            img.src = `images/random cats/cat${catNum}.png`;
            img.alt = 'Cat';
            img.style.width = '40px';
            img.style.height = '40px';
            img.style.objectFit = 'contain';
            img.style.pointerEvents = 'none'; // Let .cat div receive the click
            cat.appendChild(img);
            // Get the size of the cat (use 40px as before)
            const catSize = 40;
            const areaWidth = gameArea.offsetWidth;
            const areaHeight = gameArea.offsetHeight;
            // Ensure cats are fully inside the area and do not overlap
            let maxAttempts = 20;
            let left, top, overlap;
            do {
                left = Math.random() * (areaWidth - catSize);
                top = Math.random() * (areaHeight - catSize);
                overlap = false;
                // Check for overlap with existing cats
                const existingCats = gameArea.querySelectorAll('.cat');
                for (let existingCat of existingCats) {
                    const rect = existingCat.getBoundingClientRect();
                    const parentRect = gameArea.getBoundingClientRect();
                    const exLeft = rect.left - parentRect.left;
                    const exTop = rect.top - parentRect.top;
                    if (
                        left < exLeft + catSize &&
                        left + catSize > exLeft &&
                        top < exTop + catSize &&
                        top + catSize > exTop
                    ) {
                        overlap = true;
                        break;
                    }
                }
                maxAttempts--;
            } while (overlap && maxAttempts > 0);
            cat.style.left = left + 'px';
            cat.style.top = top + 'px';
            cat.addEventListener('click', catchCat);
            gameArea.appendChild(cat);
            setTimeout(() => {
                if (cat.parentNode) {
                    catsOnScreen.delete(catNum);
                    cat.remove();
                }
            }, 1800); // Lasts longer
        }

        function catchCat() {
            if (this.dataset.caught === 'true') return;
            this.dataset.caught = 'true';
            catScore++;
            document.getElementById('catScore').textContent = catScore;
            // Remove from catsOnScreen set
            if (this.dataset.catNum) {
                catsOnScreen.delete(parseInt(this.dataset.catNum));
            }
            // Play pop sound at gentle volume
            const popSound = document.getElementById('pop-sound');
            if (popSound) {
                popSound.currentTime = 0;
                popSound.volume = 0.25;
                popSound.play();
            }
            this.remove();
            if (catScore >= 20) {
                clearInterval(catInterval);
                clearInterval(catTimerInterval);
                // Clear any remaining cats
                const remainingCats = document.querySelectorAll('.cat');
                remainingCats.forEach(cat => cat.remove());
                setTimeout(() => {
                    alert('Amazing job! You caught all the cats so quickly! You\'re incredible!');
                    currentGame = 3;
                    showGame('game3');
                    initQuiz();
                }, 500);
            }
        }

        function initQuiz() {
            quizScore = 0;
            currentQuestion = 1;
            document.getElementById('quizScore').textContent = '0';
            
            // Reset all buttons to their original state
            const allButtons = document.querySelectorAll('.quiz-btn');
            allButtons.forEach(btn => {
                btn.classList.remove('correct', 'incorrect');
                btn.style.pointerEvents = 'auto';
            });
            
            // Randomize answers for Q1 and Q2
            randomizeQuizAnswers(1, [
                {text: 'Black', value: 'black'},
                {text: 'Pink', value: 'pink'},
                {text: 'Blue', value: 'blue'},
                {text: 'Purple', value: 'purple'}
            ]);
            randomizeQuizAnswers(2, [
                {text: '11th October 2006', value: '11th october 2006'},
                {text: '23rd March 2007', value: '23rd march 2007'},
                {text: '5th May 2006', value: '5th may 2006'},
                {text: '1st January 2005', value: '1st january 2005'}
            ]);
            // Show first question
            document.getElementById('question1').style.display = 'block';
            document.getElementById('question2').style.display = 'none';
            document.getElementById('question3').style.display = 'none';
            // Reset final quiz stage
            document.getElementById('finalQuizStage').innerHTML = '';
        }

        function randomizeQuizAnswers(qNum, answers) {
            // Use a more robust shuffle with Date.now() and Math.random for better randomness
            for (let i = answers.length - 1; i > 0; i--) {
                // Add a little entropy from time and Math.random
                const j = Math.floor((Math.random() + (Date.now() % 1000) / 1000) * (i + 1)) % (i + 1);
                [answers[i], answers[j]] = [answers[j], answers[i]];
            }
            // If the correct answer is still in the first slot, swap with another at random (not first)
            if (answers[0].value === correctAnswers[qNum]) {
                const swapIdx = 1 + Math.floor(Math.random() * (answers.length - 1));
                [answers[0], answers[swapIdx]] = [answers[swapIdx], answers[0]];
            }
            const optionsDiv = document.querySelector(`#question${qNum} .quiz-options`);
            optionsDiv.innerHTML = '';
            answers.forEach(ans => {
                optionsDiv.innerHTML += `<button class="quiz-btn" onclick="checkAnswer(${qNum}, '${ans.value}')">${ans.text}</button>`;
            });
        }

        function checkAnswer(questionNum, selectedAnswer) {
            const correctAnswer = correctAnswers[questionNum];
            const buttons = document.querySelectorAll(`#question${questionNum} .quiz-btn`);
            
            // Disable all buttons for this question
            buttons.forEach(btn => {
                btn.style.pointerEvents = 'none';
            });
            
            // Show correct/incorrect feedback
            buttons.forEach(btn => {
                if (btn.textContent.toLowerCase() === correctAnswer) {
                    btn.classList.add('correct');
                } else if (btn.textContent.toLowerCase() === selectedAnswer && selectedAnswer !== correctAnswer) {
                    btn.classList.add('incorrect');
                }
            });
            
            // Check if answer is correct
            if (selectedAnswer === correctAnswer) {
                quizScore++;
                document.getElementById('quizScore').textContent = quizScore;
            }
            
            // Wait a moment then show next question or finish
            setTimeout(() => {
                if (selectedAnswer !== correctAnswer) {
                    alert('Not quite right! Try again!');
                    // Remove .incorrect class after alert for next round
                    buttons.forEach(btn => btn.classList.remove('incorrect', 'correct'));
                    initQuiz();
                    return;
                }
                if (questionNum === 1) {
                    document.getElementById('question1').style.display = 'none';
                    document.getElementById('question2').style.display = 'block';
                } else if (questionNum === 2) {
                    document.getElementById('question2').style.display = 'none';
                    document.getElementById('question3').style.display = 'block';
                    showFinalQuizQuestion();
                }
            }, 1500);
        }

        function showFinalQuizQuestion() {
            const stage = document.getElementById('finalQuizStage');
            stage.innerHTML = `<div class='final-quiz-getready'>Get ready for the final question...</div>`;
            setTimeout(() => {
                let drumroll = document.getElementById('drumroll-sound');
                const bgMusic = document.getElementById('bg-music');
                let previousBgVolume = bgMusic ? bgMusic.volume : 0.15;
                // Remove and re-add drumroll audio element to force reload if needed
                if (drumroll) {
                    const parent = drumroll.parentNode;
                    parent.removeChild(drumroll);
                    const newDrumroll = drumroll.cloneNode(true);
                    newDrumroll.id = 'drumroll-sound';
                    parent.appendChild(newDrumroll);
                    drumroll = newDrumroll;
                }
                // Always show loading after 100ms, regardless of drumroll
                setTimeout(() => {
                    stage.innerHTML = `<div class='final-quiz-loading'><div class='loading-dots'><span class='loading-dot'>.</span><span class='loading-dot'>.</span><span class='loading-dot'>.</span></div></div>`;
                    // Always show question after 6.2s
                    setTimeout(() => {
                        stage.innerHTML = `<div class='final-quiz-question'>Did you know I love you more than anything? Yeah cringe I know sorry lol...</div>
                            <div class='quiz-options'>
                                <button class='quiz-btn' onclick='finalQuizAnswer("yes")'>Yes</button>
                                <button class='quiz-btn' onclick='finalQuizAnswer("no")'>No</button>
                            </div>
                            <div id='finalQuizFeedback'></div>`;
                    }, 6200);
                }, 100);
                // Play drumroll and fade music
                if (drumroll && bgMusic) {
                    drumroll.volume = 0.2; // Always play at lower volume
                    fadeAudio(bgMusic, 0, 1000);
                    drumroll.pause();
                    drumroll.currentTime = 0;
                    drumroll.load();
                    console.log('Attempting to play drumroll...');
                    drumroll.play().then(()=>console.log('Drumroll playing!')).catch(e=>console.log('Drumroll play error', e));
                    drumroll.onended = null;
                    drumroll.onended = function() {
                        fadeAudio(bgMusic, previousBgVolume, 1200);
                        drumroll.onended = null;
                    };
                } else if (drumroll) {
                    drumroll.volume = 0.2; // Always play at lower volume
                    drumroll.pause();
                    drumroll.currentTime = 0;
                    drumroll.load();
                    console.log('Attempting to play drumroll...');
                    drumroll.play().then(()=>console.log('Drumroll playing!')).catch(e=>console.log('Drumroll play error', e));
                }
            }, 3000); // 3 seconds for "get ready" message
        }
        function finalQuizAnswer(answer) {
            const feedback = document.getElementById('finalQuizFeedback');
            feedback.style.color = '#ff69b4';
            if (answer === 'yes') {
                feedback.textContent = "that's absolutely right :D";
                quizScore++;
                document.getElementById('quizScore').textContent = quizScore;
                setTimeout(() => {
                    // Quiz finished
                    if (quizScore >= 3) {
                        setTimeout(() => {
                            alert('Perfect! You know me so well! You really pay attention to everything I say!');
                            currentGame = 3.5; // Difficulty prompt
                            showGame('difficulty-prompt');
                        }, 1000);
                    } else {
                        alert('Not quite right! Try again!');
                        initQuiz();
                    }
                }, 1500);
            } else {
                feedback.textContent = "wrong!! of course i do >:(";
                setTimeout(() => {
                    alert('Not quite right! Try again!');
                    initQuiz();
                }, 1500);
            }
        }

        // Smoothly fade audio volume
        function fadeAudio(audioElem, targetVolume, duration) {
            if (!audioElem) return;
            const startVolume = audioElem.volume;
            const volumeDiff = targetVolume - startVolume;
            const startTime = Date.now();
            function step() {
                const elapsed = Date.now() - startTime;
                let progress = Math.min(elapsed / duration, 1);
                audioElem.volume = startVolume + volumeDiff * progress;
                if (progress < 1) {
                    requestAnimationFrame(step);
                } else {
                    audioElem.volume = targetVolume;
                }
            }
            step();
        }

        function startChallenge() {
            currentGame = 4;
            showGame('game4');
            initPatternGame();
        }

        // JS: Add timer logic for pattern memory game
        // Remove all pattern memory timer JS logic and references

        function initPatternGame() {
            patternLevel = 1;
            patternScore = 0;
            patternSequence = [];
            playerSequence = [];
            isShowingPattern = false;
            isPlayerTurn = false;
            
            document.getElementById('patternLevel').textContent = patternLevel;
            document.getElementById('patternScore').textContent = patternScore;
            
            // Show start screen
            document.getElementById('patternStart').style.display = 'block';
            document.getElementById('patternCountdown').style.display = 'none';
            document.getElementById('patternGrid').style.display = 'none';
            // Reset timer
            // resetPatternTimer(); // This function is removed
        }

        function startPatternGame() {
            // Unlock audio if not already done
            if (!window._audioUnlocked) {
                unlockAllAudio();
            }
            // Hide start screen, show countdown
            document.getElementById('patternStart').style.display = 'none';
            document.getElementById('patternCountdown').style.display = 'block';
            // Start countdown
            let countdown = 3;
            const countdownElement = document.getElementById('countdownNumber');
            countdownElement.textContent = countdown;
            countdownElement.style.animation = 'none';
            setTimeout(() => {
                countdownElement.style.animation = 'pulse 1s ease-in-out';
            }, 10);
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    countdownElement.textContent = countdown;
                } else if (countdown === 0) {
                    countdownElement.textContent = 'Go!';
                } else {
                    clearInterval(countdownInterval);
                    document.getElementById('patternCountdown').style.display = 'none';
                    document.getElementById('patternGrid').style.display = 'grid';
                    // Initialize the game
                    initializePatternGame();
                }
                countdownElement.style.animation = 'none';
                setTimeout(() => {
                    countdownElement.style.animation = 'pulse 1s ease-in-out';
                }, 10);
            }, 1000);
        }

        function initializePatternGame() {
            console.log('Initializing pattern game...');
            // Reset cells and remove any existing classes
            const cells = document.querySelectorAll('.pattern-cell');
            console.log('Found', cells.length, 'pattern cells');
            cells.forEach(cell => {
                cell.classList.remove('active', 'correct', 'incorrect', 'selected');
                // Remove any existing click listeners by cloning and replacing
                const newCell = cell.cloneNode(true);
                cell.parentNode.replaceChild(newCell, cell);
            });
            
            // Add fresh click listeners to the new cells
            const freshCells = document.querySelectorAll('.pattern-cell');
            console.log('Added click listeners to', freshCells.length, 'cells');
            freshCells.forEach(cell => {
                cell.addEventListener('click', () => handlePatternClick(cell));
            });
            
            // Make sure the pattern grid is visible
            document.getElementById('patternGrid').style.display = 'grid';
            // Start the first round immediately
            generatePattern();
        }

        function generatePattern() {
            isShowingPattern = true;
            isPlayerTurn = false;
            
            // Generate new sequence
            patternSequence = [];
            for (let i = 0; i < patternLevel; i++) {
                patternSequence.push(Math.floor(Math.random() * 4));
            }
            
            console.log('Generated pattern:', patternSequence);
            
            // Show the pattern
            showPattern(0);
        }

        function showPattern(index) {
            if (index >= patternSequence.length) {
                // Instead of immediately enabling player turn, wait for the last highlight to finish
                setTimeout(() => {
                    isShowingPattern = false;
                    isPlayerTurn = true;
                    playerSequence = [];
                    console.log('Pattern shown, now player turn');
                }, 180); // was 300, now faster
                return;
            }
            
            const cell = document.querySelector(`[data-index="${patternSequence[index]}"]`);
            if (cell) {
                cell.classList.add('active');
                console.log('Showing pattern index:', patternSequence[index]);
                // Play beep for this cell
                playBeep(patternFrequencies[patternSequence[index]]);
            }
            
            setTimeout(() => {
                if (cell) {
                    cell.classList.remove('active');
                }
                setTimeout(() => {
                    showPattern(index + 1);
                }, 120); // was 300, now faster
            }, 260); // was 500, now faster
        }

        function handlePatternClick(cell) {
            if (!isPlayerTurn || isShowingPattern) {
                console.log('Click ignored - not player turn or showing pattern');
                return;
            }
            
            const index = parseInt(cell.dataset.index);
            playerSequence.push(index);
            console.log('Player clicked:', index, 'Sequence so far:', playerSequence);
            // Play beep for this cell
            playBeep(patternFrequencies[index], 120, 0.13);
            
            // Highlight this cell as selected
            cell.classList.add('selected');
            cell.classList.add('active');
            setTimeout(() => {
                cell.classList.remove('active');
            }, 200);
            
            // Check if the sequence is correct so far
            const currentIndex = playerSequence.length - 1;
            if (playerSequence[currentIndex] !== patternSequence[currentIndex]) {
                // Wrong sequence
                console.log('Wrong sequence! Expected:', patternSequence[currentIndex], 'Got:', playerSequence[currentIndex]);
                cell.classList.add('incorrect');
                setTimeout(() => {
                    // Remove all selected highlights
                    document.querySelectorAll('.pattern-cell').forEach(c => c.classList.remove('selected'));
                    alert(`Game Over! You got to level ${patternLevel}. Try again!`);
                    initPatternGame();
                }, 500);
                return;
            }
            
            // Correct so far
            cell.classList.add('correct');
            setTimeout(() => {
                cell.classList.remove('correct');
            }, 300);
            
            // Check if sequence is complete
            if (playerSequence.length === patternSequence.length) {
                console.log('Level complete! Moving to next level');
                setTimeout(() => {
                    // Remove all selected highlights
                    document.querySelectorAll('.pattern-cell').forEach(c => c.classList.remove('selected'));
                }, 350);
                patternScore += patternLevel;
                patternLevel++;
                document.getElementById('patternLevel').textContent = patternLevel;
                document.getElementById('patternScore').textContent = patternScore;
                
                // Check if they've reached the goal (level 7)
                if (patternLevel > 7) {
                    setTimeout(() => {
                        alert('Incredible! Your memory is absolutely amazing! You\'re a pattern master!');
                        currentGame = 5;
                        showGame('final');
                    }, 1000);
                } else {
                    // Next round
                    setTimeout(() => {
                        generatePattern();
                    }, 1000);
                }
            }
        }

        function showHint(game) {
            if (game === 'memory') {
                alert('Hint: Look for pairs of the same cat picture!');
            } else if (game === 'quiz') {
                alert('Hint: Think about what I talk about most! What do I always say I love?');
            } else if (game === 'pattern') {
                alert('Hint: Watch the pattern carefully and remember the order! Focus on one symbol at a time!');
            }
        }

        // Dev mode functions
        function toggleDevMode() {
            devMode = !devMode;
            const panel = document.getElementById('devPanel');
            panel.style.display = devMode ? 'block' : 'none';
        }

        function devSkipTo(section) {
            // Set appropriate game state based on section
            switch(section) {
                case 'welcome':
                    currentGame = 0;
                    break;
                case 'game1':
                    currentGame = 1;
                    initMemoryGame();
                    break;
                case 'game2':
                    currentGame = 2;
                    initCatGame();
                    break;
                case 'game3':
                    currentGame = 3;
                    initQuiz();
                    break;
                case 'difficulty-prompt':
                    currentGame = 3.5;
                    break;
                case 'game4':
                    currentGame = 4;
                    initPatternGame();
                    break;
                case 'final':
                    currentGame = 5;
                    break;
            }
            
            showGame(section);
            toggleDevMode(); // Close the panel
        }

        // Keyboard shortcut for dev mode (Ctrl + Shift + D)
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                e.preventDefault();
                toggleDevMode();
            }
        });

        // Book message navigation and voice player logic
        let bookCurrentPage = 0;
        const bookTotalPages = 2; // Update this if you add more pages
        function showBookPage(page) {
            for (let i = 0; i < bookTotalPages; i++) {
                const pg = document.getElementById('bookPage' + i);
                if (pg) pg.style.display = (i === page) ? 'block' : 'none';
            }
            document.getElementById('bookPrev').style.display = (page === 0) ? 'none' : 'flex';
            document.getElementById('bookNext').style.display = (page === bookTotalPages - 1) ? 'none' : 'flex';
            bookCurrentPage = page;
            // Update page indicator
            const indicator = document.getElementById('bookPageIndicator');
            if (indicator) {
                indicator.textContent = `Page ${page + 1}/${bookTotalPages}`;
            }
        }
        function bookPrevPage() { showBookPage(Math.max(0, bookCurrentPage - 1)); }
        function bookNextPage() { showBookPage(Math.min(bookTotalPages - 1, bookCurrentPage + 1)); }
        // Show first page on load of final message
        const origShowGame = showGame;
        showGame = function(gameId) {
            origShowGame(gameId);
            if (gameId === 'final') {
                showBookPage(0);
            }
        }
        // Voice player logic
        let voiceAudio, voicePlayBtn, voicePlayIcon, voiceProgress, voiceCurrent, voiceDuration;
        function setupVoicePlayer() {
            voiceAudio = document.getElementById('voiceAudio');
            voicePlayBtn = document.getElementById('voicePlayBtn');
            voicePlayIcon = document.getElementById('voicePlayIcon');
            voiceProgress = document.getElementById('voiceProgress');
            voiceCurrent = document.getElementById('voiceCurrent');
            voiceDuration = document.getElementById('voiceDuration');
            if (!voiceAudio) return;
            // Update duration when loaded
            voiceAudio.addEventListener('loadedmetadata', function() {
                voiceDuration.textContent = formatTime(voiceAudio.duration);
                voiceProgress.max = voiceAudio.duration;
            });
            // Update progress bar and time
            voiceAudio.addEventListener('timeupdate', function() {
                voiceProgress.value = voiceAudio.currentTime;
                voiceCurrent.textContent = formatTime(voiceAudio.currentTime);
                // Change to restart icon if at end
                if (voiceAudio.currentTime >= voiceAudio.duration - 0.1) {
                    // Try bx-replay, fallback to bx-refresh if not visible
                    voicePlayIcon.className = 'bx bx-replay';
                    if (!voicePlayIcon.offsetHeight || voicePlayIcon.offsetHeight === 0) {
                        voicePlayIcon.className = 'bx bx-refresh';
                    }
                } else if (voiceAudio.paused) {
                    voicePlayIcon.className = 'bx bx-play';
                } else {
                    voicePlayIcon.className = 'bx bx-pause';
                }
            });
            // Seek
            voiceProgress.addEventListener('input', function() {
                voiceAudio.currentTime = voiceProgress.value;
            });
            // Reset icon on ended
            voiceAudio.addEventListener('ended', function() {
                voicePlayIcon.className = 'bx bx-replay';
                if (!voicePlayIcon.offsetHeight || voicePlayIcon.offsetHeight === 0) {
                    voicePlayIcon.className = 'bx bx-refresh';
                }
            });
        }
        function toggleVoicePlayback() {
            if (!voiceAudio) return;
            if (voiceAudio.currentTime >= voiceAudio.duration - 0.1) {
                voiceAudio.currentTime = 0;
                voiceAudio.play();
                voicePlayIcon.className = 'bx bx-pause';
            } else if (voiceAudio.paused) {
                voiceAudio.play();
                voicePlayIcon.className = 'bx bx-pause';
            } else {
                voiceAudio.pause();
                voicePlayIcon.className = 'bx bx-play';
            }
        }
        function formatTime(sec) {
            sec = Math.floor(sec);
            const m = Math.floor(sec / 60);
            const s = sec % 60;
            return m + ':' + (s < 10 ? '0' : '') + s;
        }
        // Setup on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            setupVoicePlayer();
        });
    </script>
</body>
</html>

